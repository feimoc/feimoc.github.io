---
layout:     post
title:      Swoole的心跳功能
subtitle:   php 进阶
date:       2017-01-06
author:     feimo
header-img: img/tag-bg-o.jpg
catalog: true
tags:
    - PHP
    - Swoole
---
# 心跳是什么？

顾名思义，心跳是判断一个事物生还是死的一个标准，在swoole里，心跳是指用来判断一个连接是正常还是断开的。

# 从TCP协议说起

我们都知道一个五元组标识一个网络连接，创建一个连接有三次握手，而断开一个连接有四次挥手。不管是服务器还是客户端
发起连接的关闭，都会完整的走完四次挥手的过程，这样，一切很完美，系统回收这个fd，应用层也可以通过onClose回调处理相关的事情.

# fd是什么？
fd学名是文件描述符，在unix的哲学就是一切皆文件中，这个fd就是系统层暴露给业务层的用来表示一个五元组网络连接的标识。你可以简单的理解为一个索引，通过对这个fd的操作，系统层可以找到相应的连接而且进行的一系列操作，如发送数据到网瞳，进行连接关闭等等。

#为什么要心跳？
刚才提到，如果我们要关闭某个连接，我们可以在业务层对fd发起关闭连接的操作，以swoole为例：
```php
$server->close($fd);
```
正常情况下，都会走完整个四次挥手，（swoole会有onClose回调），系统回收fd，以待分配给其他的连接。
那系统为什么要回收fd，因为fd资源是有限的，所以必需重复利用。
但在某些情况下，如突然拔掉网线或蓝翔演习挖断光缆，服务端并不能感知到这个连接的异常，但实际上是这个连接已经失效了，如果没有一个回收机制，这类连接将用光所有的fd，导致系统不再能接受新的连接请求，所以就有了心跳机制。

# 什么是心跳机制？
心跳机制就是业务层来提供一个连接是否存活的一个方法，让系统能判定一个连接是否失效。一般有两种实现方式：
- 1:客户端定时发送一个心跳包，告诉服务器我还活着，服务器定时检测所有客户端列表，看他们最后一个心跳包的时间是否过长，如果过长，则认为已无心跳，判定为死连接，主动关闭这个连接。
- 2:服务器定时询问所有的客户端，你们还活着么？如果活着，给我个回馈,没得到回馈的客户端，格杀勿论。

# 两种心跳方案有什么区别？
第一种方案，对服务器和网络的压力更小，而且更具有灵活性，但需要客户端配合定时发送心跳包。
第二种方案，对服务器和网络压力更大，不建议使用。

# 心跳在swoole里的实现
swoole采用的是第一种方案
swoole会在主进程独立起一个心跳线程，通过定时轮询所有的连接，来判断连接的生死，所以swoole的心跳不会堵塞任何业务逻辑。
那怎么判断连接的生死了？swoole在connection结构体中有 time_t last_time 字段，用来存放最后一次收包的时间戳，进而通过与这个时间对比来判定是否存活
于是，swoole有两个配置：
heartbeat_check_interval： 服务器定时检测在线列表的时间
heartbeat_idle_time：      连接最大的空闲时间 （如果最后一个心跳包的时间与当前时间之差超过这个值，则认为该连接失效）

# 配置建议
建议 heartbeat_idle_time 为 heartbeat_check_interval 的两倍多一点。

这个两倍是为了进行容错，允许丢一个包

而多一点是考虑到网络的延时。


你可以跟据实际的业务来调整这个容错率（允许丢几个包）。